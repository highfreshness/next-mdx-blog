---
title: ğŸ”ï¸ Nginx
description: Nginx í•™ìŠµ ë° ì‹¤ìŠµ
date: 2024-03-25
published: true
---

## Nginxë€?

**ê²½ëŸ‰í™”ëœ ì›¹ ì„œë²„ë¡œ ê³ ì„±ëŠ¥, ì•ˆì •ì , ì—­ë°©í–¥ í”„ë¡ì‹œì™€ ê°™ì€ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ê°€ì§„** 

## Nginxì˜ íŠ¹ì¥ì 

- **ë†’ì€ ì²˜ë¦¬ ì†ë„:** ë¹„ë™ê¸° ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë§ì€ ë™ì‹œ ì ‘ì†ì„ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬
- **ë‚®ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©:** ì ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ìœ¼ë¡œë„ ë†’ì€ ì„±ëŠ¥ì„ ìœ ì§€
- **ë‹¤ì–‘í•œ ê¸°ëŠ¥:** ì›¹ ì„œë²„, ì—­ë°©í–¥ í”„ë¡ì‹œ, ë¡œë“œ ë°¸ëŸ°ì„œ, ìºì‹±, SSL/TLS í„°ë¯¸ë„¤ì´ì…˜ ë“± ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µ
    - Nginxë¥¼ WAS ì•ì— ë†“ì€ ê²½ìš° WASë¡œ ì§ì ‘ì ì¸ ì ‘ì†ì„ ë§‰ì•„ IP ë…¸ì¶œì„ í”¼í•  ìˆ˜ ìˆìœ¼ë©° ê°™ì€ ê¸°ëŠ¥ì„ í•˜ëŠ” ì—¬ëŸ¬ëŒ€ì˜ ì„œë²„ë¥¼ ê°€ì§€ê³  ìˆëŠ” ê²½ìš° í˜„ì¬ ë™ì‘í•˜ì§€ ì•ŠëŠ” ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚´ í•˜ë‚˜ì˜ ì„œë²„ì— ê°€í•´ì§€ëŠ” ë¶€í•˜ë¥¼ ëœ ìˆ˜ ìˆë‹¤
- **ë†’ì€ í™•ì¥ì„±:** ëª¨ë“ˆí™”ëœ êµ¬ì¡°ë¡œ í•„ìš”ì— ë”°ë¼ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê±°ë‚˜ í™•ì¥ ê°€ëŠ¥
- **ìœ ì—°í•œ ì„¤ì •:** ë‹¤ì–‘í•œ ì„¤ì • ì˜µì…˜ì„ í†µí•´ ì‚¬ìš©ì í™˜ê²½ì— ë§ê²Œ ì¡°ì • ê°€ëŠ¥
- **ì˜¤í”ˆ ì†ŒìŠ¤:** ë¬´ë£Œ ì˜¤í”ˆ ì†ŒìŠ¤ ì†Œí”„íŠ¸ì›¨ì–´ë¡œ ëˆ„êµ¬ë‚˜ ììœ ë¡­ê²Œ ì‚¬ìš©í•˜ê³  ìˆ˜ì • ê°€ëŠ¥

## Mission

1. Nginxì˜ ì¸ì¦ ì „ìš© í˜ì´ì§€ì— HTTP ì…ë ¥ìœ¼ë¡œ ì•¡ì„¸ìŠ¤ í† í°ì„ ì£¼ë©´ Nginxì—ì„œ FastAPIì˜ í† í° ê²€ì¦ APIë¡œ ë³´ë‚´ ì¸ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ë˜ì—ˆë‹¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ë³´ì•ˆ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•œë‹¤. 
2. ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ FastAPIì˜ HTTP ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ë°˜í™˜í•œë‹¤.

## Mission flow

HTTP response(in access token) â†’ Nginx/login â†’ FastAPI/auth_check â†’ Nginx/login â†’ FastAPI/auth/success 

## ì§„í–‰

1. Udemyì˜ Nginx ê¸°ì´ˆ ê°•ì˜ í•™ìŠµ [[ë§í¬](https://www.udemy.com/course/nginx-fundamentals/)]
    1. Nginx ì„¤ì¹˜ ì‹œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ê°€ ì•„ë‹Œ ì›ë³¸ ì½”ë“œë¡œ ì„¤ì¹˜(íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œ ì¶”ê°€ ì˜µì…˜ ì œì•½ì´ ìˆì„ ìˆ˜ ìˆë‹¤ëŠ” ê²ƒìœ¼ë¡œ í•™ìŠµ)
    2. ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œ ì‹¤ìŠµ ì§„í–‰ ì‹œ ìœ ì € ê¶Œí•œ ë¬¸ì œ ë°œìƒ í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ì˜
2. Web Server Nginxì™€ WAS FastAPI ì„œë²„ë¥¼ ë¡œì»¬ì—ì„œ ì„¤ì¹˜ í›„ Postmanìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì§„í–‰
    1. Nginx, FastAPIëŠ” ê°ê°ì˜ Dockerfileì„ ë§Œë“¤ì–´ ì´ë¯¸ì§€ ìƒì„± í›„ í…ŒìŠ¤íŠ¸
    2. Docker composeë¡œ Nginx, FastAPIë¥¼ ê°™ì´ êµ¬ë™ì‹œí‚¤ê³  Network ë¬¶ê¸°

## ì™„ì„± ì½”ë“œ

1. Nginx
    1. Dockerfile
        
        ```bash
        FROM ubuntu:20.04
        
        RUN apt update
        
        RUN apt install -y curl \
            vim \
            wget \
            build-essential \
            libpcre3 \
            libpcre3-dev \
            zlib1g \
            zlib1g-dev \
            libssl-dev
        
        WORKDIR /app
        
        RUN wget https://nginx.org/download/nginx-1.24.0.tar.gz && \
            tar -zxvf nginx-1.24.0.tar.gz
        
        WORKDIR /app/nginx-1.24.0
        
        RUN ./configure \
            --sbin-path=/usr/bin/nginx \ 
            --conf-path=/etc/nginx/nginx.conf \
            --error-log-path=/var/log/nginx/error.log \
            --http-log-path=/var/log/nginx/access.log \
            --pid-path=/var/run/nginx.pid \
            --with-http_ssl_module \
            --with-http_auth_request_module
        
        RUN make
        
        RUN make install
        
        COPY nginx.conf /app 
        
        RUN mv /app/nginx.conf /etc/nginx/nginx.conf
        
        CMD ["nginx", "-g", "daemon off;"]
        ```
        
        1. ì£¼ì˜ ë° ì°¸ê³ ì‚¬í•­
            1. nginx íŒŒì¼ì€ [https://nginx.org/en/download.html](https://nginx.org/en/download.html) ì—ì„œ Stable ë²„ì „ì„ ì„ íƒ
            2. ./configure ì‹œ ì£¼ëŠ” argumentëŠ” ìƒí™©ì— ë§ê²Œ ë¶€ì—¬
            3. nginx -g daemon off ëŠ” nginx ì»¤ë§¨ë“œë§Œ ì…ë ¥í•  ê²½ìš° nginxê°€ background ì—ì„œ ëŒê¸° ë•Œë¬¸ì— ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ êº¼ì§€ì§€ ì•Šë„ë¡ foreground ë¡œ ì‹¤í–‰ë  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì—­í• ì´ë‹¤.
    2. nginx.conf
        
        ```bash
        pid /var/run/nginx.pid;
        
        events {}
        
        http {
        
            upstream api-server {
                server fastapi:8000;
            }
        
            include /etc/nginx/mime.types;
        
            server {
                listen 80;
                location /login {
                    auth_request /auth;
                    error_page 401 = @auth_failed;
                    rewrite / /auth/success break;
                    proxy_pass http://api-server;
                }
        
                location /auth {
                    internal;
                    rewrite / /users/me break;
                    proxy_pass http://api-server;
                }
        
                location /proxy_test {
                    rewrite / /check break;
                    proxy_pass http://api-server;
                }
          
                location @auth_failed {
                    internal;
                    rewrite / /users/me break; 
                    proxy_pass http://api-server;
                }
            }
        }
        ```
        
        1. ì£¼ì˜ ë° ì°¸ê³ ì‚¬í•­
            1. proxy_pass URIë¥¼ ì§€ì •í•  ë•Œ ê°€ê¸‰ì  upstream ì´ë¦„ë§Œ ì‘ì„± í›„ ì´í›„ êµ¬ë¶„ìëŠ” rewriteë¥¼ ì‚¬ìš©
            2. internal ì˜µì…˜ì€ ì™¸ë¶€ì—ì„œ í•´ë‹¹ location ì ‘ê·¼ì„ í—ˆë½í•˜ì§€ ì•Šê³  ë‚´ë¶€ì—ì„œì˜ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¡œë§Œ ë™ì‘í•˜ê²Œ í•˜ëŠ” ì˜µì…˜ì´ë‹¤.
2. FastAPI
    1. Dockerfile
        
        ```bash
        FROM python:3.10.13-bullseye
        
        WORKDIR /app
        
        RUN pip install "fastapi[all]" "passlib[bcrypt]" "python-jose[cryptography]"
        
        COPY main.py ./
        
        CMD ["uvicorn", "main:app", "--reload", "--host", "0.0.0.0", "--log-level", "debug"]
        
        ```
        
    2. [main.py](http://main.py) ( [ì°¸ì¡°ë§í¬](https://fastapi.tiangolo.com/ko/tutorial/security/oauth2-jwt/#__tabbed_1_1) )
        
        ```python
        from datetime import datetime, timedelta, timezone
        from typing import Annotated
        
        from fastapi import Depends, FastAPI, HTTPException, status
        from fastapi.security import OAuth2PasswordBearer, OAuth2PasswordRequestForm
        from jose import JWTError, jwt
        from passlib.context import CryptContext
        from pydantic import BaseModel
        
        # to get a string like this run:
        # openssl rand -hex 32
        SECRET_KEY = "09d25e094faa6ca2556c818166b7a9563b93f7099f6f0f4caa6cf63b88e8d3e7"
        ALGORITHM = "HS256"
        ACCESS_TOKEN_EXPIRE_MINUTES = 30
        
        fake_users_db = {
            "johndoe": {
                "username": "johndoe",
                "full_name": "John Doe",
                "email": "johndoe@example.com",
                "hashed_password": "$2b$12$EixZaYVK1fsbw1ZfbX3OXePaWxn96p36WQoeG6Lruj3vjPGga31lW",
                "disabled": False,
            }
        }
        
        class Token(BaseModel):
            access_token: str
            token_type: str
        
        class TokenData(BaseModel):
            username: str | None = None
        
        class User(BaseModel):
            username: str
            email: str | None = None
            full_name: str | None = None
            disabled: bool | None = None
        
        class UserInDB(User):
            hashed_password: str
        
        pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
        
        oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")
        
        app = FastAPI()
        app.router.redirect_slashes = False
        
        def verify_password(plain_password, hashed_password):
            return pwd_context.verify(plain_password, hashed_password)
        
        def get_password_hash(password):
            return pwd_context.hash(password)
        
        def get_user(db, username: str):
            if username in db:
                user_dict = db[username]
                return UserInDB(**user_dict)
        
        def authenticate_user(fake_db, username: str, password: str):
            user = get_user(fake_db, username)
            if not user:
                return False
            if not verify_password(password, user.hashed_password):
                return False
            return user
        
        def create_access_token(data: dict, expires_delta: timedelta | None = None):
            to_encode = data.copy()
            if expires_delta:
                expire = datetime.now(timezone.utc) + expires_delta
            else:
                expire = datetime.now(timezone.utc) + timedelta(minutes=15)
            to_encode.update({"exp": expire})
            encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
            return encoded_jwt
        
        async def get_current_user(token: Annotated[str, Depends(oauth2_scheme)]):
            credentials_exception = HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="Could not validate credentials",
                headers={"WWW-Authenticate": "Bearer"},
            )
            try:
                payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
                username: str = payload.get("sub")
                if username is None:
                    raise credentials_exception
                token_data = TokenData(username=username)
            except JWTError:
                raise credentials_exception
            user = get_user(fake_users_db, username=token_data.username)
            if user is None:
                raise credentials_exception
            return user
        
        async def get_current_active_user(
            current_user: Annotated[User, Depends(get_current_user)]
        ):
            if current_user.disabled:
                raise HTTPException(status_code=400, detail="Inactive user")
            return current_user
        
        @app.post("/token")
        async def login_for_access_token(
            form_data: Annotated[OAuth2PasswordRequestForm, Depends()]
        ) -> Token:
            user = authenticate_user(fake_users_db, form_data.username, form_data.password)
            if not user:
                raise HTTPException(
                    status_code=status.HTTP_401_UNAUTHORIZED,
                    detail="Incorrect username or password",
                    headers={"WWW-Authenticate": "Bearer"},
                )
            access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
            access_token = create_access_token(
                data={"sub": user.username}, expires_delta=access_token_expires
            )
            return Token(access_token=access_token, token_type="bearer")
        
        @app.get("/users/me", response_model=User)
        async def read_users_me(
            current_user: Annotated[User, Depends(get_current_active_user)]
        ):
            return current_user
        
        @app.get("/users/me/items")
        async def read_own_items(
            current_user: Annotated[User, Depends(get_current_active_user)]
        ):
            return [{"item_id": "Foo", "owner": current_user.username}]
        
        @app.get("/check")
        async def access_check():
            return {"message": "Access OK"}
        
        @app.get("/auth/success")
        async def success_auth():
            return {"message": "Successful authentication!"}
        
        @app.get("/security")
        async def security_page():
            return {"message": "Welcom security page."}
        
        ```
        
        1. ì£¼ì˜ ë° ì°¸ê³ ì‚¬í•­
            1. ìœ„ main.pyì˜ ID/PW ëŠ” johndoe / secret ì´ë‹¤.
3. Docker Compose.yaml
    
    ```docker
    version: "3.7"
    services:
      nginx:
        image: vp_nginx:latest
        ports: 
          - "80:80"
        volumes:
          - ./nginx/nginx.conf:/etc/nginx/nginx.conf
        networks:
          - my_network
      
      fastapi:
        image: fastapi_token:latest
        ports:
          - "8000:8000"
        volumes:
          - ./fastapi_token/main.py:/app/main.py
        networks:
          - my_network
    
    networks:
      my_network:
    ```
    

## ì‹¤í—˜ìˆœì„œ ë° ê²°ê³¼

1. Fastapiì˜ /token ì—ì„œ ID/PWë¥¼ ì…ë ¥ í›„ Bearer Token ì„ ë³µì‚¬í•œë‹¤.
2. Postman ë˜ëŠ” curl ì—ì„œ Authorization í—¤ë”ì— Bearer Token ê°’ì„ ì¶”ê°€ í›„ nginx/login ìœ¼ë¡œ ë³´ë‚¸ë‹¤.
3. ì„±ê³µ ì‹œ 
    
    ```
    {
        "message": "Successful authentication!"
    }
    ```
    
    ì‹¤íŒ¨ ì‹œ 
    
    ```json
    {
        "detail": "Could not validate credentials"
    }
    ```
    
4. ìœ„ ì²˜ëŸ¼ ì¸ì¦ ì‹¤íŒ¨ ì‹œì—ë„ Fastapi ì„œë²„ì˜ messageë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.